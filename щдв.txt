"use client";

import { useSearchParams } from "next/navigation";
import axios from "axios";
import { useEffect, useState, useCallback } from "react";
import Card from "@/components/Card";
import { Book } from "../types/Book.types";
import Link from "next/link";
import { useInView } from "react-intersection-observer";

const SearchResults: React.FC = () => {
  const searchParams = useSearchParams();
  const query = searchParams.get("query");
  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_API;

  const [bookData, setBookData] = useState<Book[]>([]);
  const [startIndex, setStartIndex] = useState(0);
  const [hasMore, setHasMore] = useState(true);

  const fetchBooks = useCallback(
    (query: string, startIndex: number) => {
      axios
        .get(
          `https://www.googleapis.com/books/v1/volumes?q=${query}&key=${apiKey}&startIndex=${startIndex}&maxResults=20`
        )
        .then((res) => {
          if (res.data.items) {
            const newBooks = res.data.items || [];
            setBookData((prev) => [...prev, ...newBooks]);
            setHasMore(newBooks.length === 20);
          } else {
            setHasMore(false);
          }
        })
        .catch((err) => console.log(err));
    },
    [apiKey]
  );

  useEffect(() => {
    if (query) {
      setBookData([]);
      setStartIndex(0);
      setHasMore(true);
      fetchBooks(query, 0);
    }
  }, [query, fetchBooks]);

  const loadMore = useCallback(() => {
    if (hasMore && query) {
      fetchBooks(query, startIndex);
      setStartIndex((prev) => prev + 20); // Increment startIndex after fetching
    }
  }, [hasMore, query, startIndex, fetchBooks]);

  const { ref, inView, entry } = useInView({
    threshold: 1.0,
    triggerOnce: false,
  });

  useEffect(() => {
    if (inView) {
      loadMore();
    }
  }, [inView, loadMore]);

  return (
    <>
      <Link href="/" className="mx-auto">
        <button className="p-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600">
          Back to Search
        </button>
      </Link>
      <div className="container flex justify-center mx-auto">
        <Card bookData={bookData} />
      </div>
    </>
  );
};

export default SearchResults;
